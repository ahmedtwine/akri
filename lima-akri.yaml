images:
- location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-amd64.img"
  arch: "x86_64"
- location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
  arch: "aarch64"

cpus: 4
memory: "8GiB"
disk: "32GiB"

mounts:
- location: "~/Documents/Github/akri"
  mountPoint: "/workspace/akri"
  writable: true

ssh:
  localPort: 0
  loadDotSSHPubKeys: true

containerd:
  system: false
  user: false

provision:
- mode: system
  script: |
    #!/bin/bash
    set -eux -o pipefail
    apt-get update
    # Install Akri's required dependencies from setup.sh
    apt-get install -y \
      git \
      curl \
      gcc \
      g++ \
      libssl-dev \
      pkg-config \
      libudev-dev \
      libv4l-dev \
      build-essential \
      cmake \
      libclang-dev \
      clang \
      linux-headers-generic \
      python3 \
      python3-pip \
      protobuf-compiler
    
    # Install Helm
    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

- mode: user
  script: |
    #!/bin/bash
    set -eux -o pipefail
    # Install Rust with the exact version Akri uses (v1.82.0)
    if ! command -v rustup &> /dev/null; then
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain=1.82.0
    fi
    source $HOME/.cargo/env
    rustup default 1.82.0
    rustup component add rustfmt
    # Add target for musl builds (optional but useful)
    rustup target add x86_64-unknown-linux-musl